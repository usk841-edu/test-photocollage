<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>A4 Photo Tiler Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: system-ui, -apple-system, sans-serif;
    padding: 16px;
  }
  canvas {
    width: 100%;
    max-width: 600px;
    border: 1px solid #ccc;
    touch-action: none;
    margin-top: 12px;
  }
  .controls {
    margin-top: 12px;
  }
</style>
</head>
<body>

<h2>A4 3×7 写真タイル（編集可）</h2>

<input type="file" id="photos" accept="image/*" multiple>

<canvas id="canvas"></canvas>

<div class="controls">
  <label>
    拡大縮小：
    <input type="range" id="scale" min="0.5" max="2" step="0.01" value="1">
  </label>
  <br>
  <label>
    <input type="checkbox" id="rotate">
    90度回転
  </label>
</div>

<button id="download">この内容でダウンロード</button>

<script>
(() => {
  const COLS = 3;
  const ROWS = 7;
  const A4_WIDTH = 2480;
  const A4_HEIGHT = 3508;

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = A4_WIDTH;
  canvas.height = A4_HEIGHT;

  const input = document.getElementById('photos');
  const scaleInput = document.getElementById('scale');
  const rotateInput = document.getElementById('rotate');

  let tiles = [];
  let activeIndex = null;
  let dragStart = null;

  input.addEventListener('change', loadPhotos);

  scaleInput.addEventListener('input', () => {
    if (activeIndex !== null) {
      tiles[activeIndex].scale = +scaleInput.value;
      draw();
    }
  });

  rotateInput.addEventListener('change', () => {
    if (activeIndex !== null) {
      tiles[activeIndex].rotate = rotateInput.checked;
      draw();
    }
  });

  canvas.addEventListener('pointerdown', e => {
    const { offsetX, offsetY } = getCanvasPos(e);
    activeIndex = hitTest(offsetX, offsetY);
    if (activeIndex !== null) {
      const t = tiles[activeIndex];
      scaleInput.value = t.scale;
      rotateInput.checked = t.rotate;
      dragStart = { x: offsetX, y: offsetY };
    }
  });

  canvas.addEventListener('pointermove', e => {
    if (dragStart && activeIndex !== null) {
      const { offsetX, offsetY } = getCanvasPos(e);
      tiles[activeIndex].offsetX += offsetX - dragStart.x;
      tiles[activeIndex].offsetY += offsetY - dragStart.y;
      dragStart = { x: offsetX, y: offsetY };
      draw();
    }
  });

  canvas.addEventListener('pointerup', () => dragStart = null);
  canvas.addEventListener('pointerleave'
